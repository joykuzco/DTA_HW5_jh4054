---
title: "p8105_hw5_jh4054"
author: "Joy Hsu"
date: "11/5/2018"
output: html_document
---

### 0. Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(rvest)

set.seed(1)

knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

### Problem 1
```{r}
#tidy dataset
patient_df = 
  tibble(
    id = c(str_c("con_0", 01:9), "con_10", str_c("exp_0", 01:9), "exp_10"),
    csv = list.files("./data", full.names = TRUE),
    data = map(csv, read_csv)) %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  gather(key = week, value = observation, week_1:week_8) %>% 
  mutate(week = str_replace(week, "week_", ""),
         arm = str_replace(id, "_..", ""),
         id = str_replace(id, "..._", ""),
         week = as.integer(as.factor(week)),
         id = as.factor(id)) %>% 
  select(arm, id, week, observation) %>%
  arrange(arm, id, week)

#spaghetti plot
patient_plot = patient_df %>% 
  group_by(id) %>% 
  ggplot(aes(x = week, y = observation, color = id)) +
  geom_line() +
  facet_grid(~arm) +
  viridis::scale_color_viridis(discrete = TRUE)
patient_plot

#linear model
lm_exp = lm(week ~ observation, data = filter(patient_df, arm == "exp")) %>% broom::tidy() %>% mutate(sig = p.value < 0.05)
lm_con = lm(week ~ observation, data = filter(patient_df, arm == "con")) %>% broom::tidy() %>% mutate(sig = p.value < 0.05)
```

```{r}
#Method 2: provide a character vector of the names of files in named directory data
patient_id2 = 
  tibble(
    id = c(str_c("con_0", 01:9), "con_10", str_c("exp_0", 01:9), "exp_10")) %>%
  mutate(csv = str_c("./data/", id, ".csv")) 
  
patient_df2 = patient_id %>% 
  mutate(observation = map(patient_id$csv, read_csv)) %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  gather(key = week, value = observation, week_1:week_8) %>% 
  mutate(week = str_replace(week, "week_", ""),
         arm = str_replace(id, "_..", ""),
         id = str_replace(id, "..._", ""),
         week = as.integer(as.factor(week)),
         id = as.factor(id)) %>% 
  select(arm, id, week, observation) %>%
  arrange(arm, id, week)
```

### Problem 2

```{r}
homicide_data = read_csv("./data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    city_state = str_c(city, ", ", state),
    city_state = str_replace(city_state, "Tulsa, AL", "Tulsa, OK"),
    hom_unsolved = ifelse(disposition == "Closed without arrest" | disposition == "Open/No arrest", TRUE, FALSE))

#total homicides
homicide_total = homicide_data %>% 
  group_by(city_state) %>% 
  summarise(hom_total = n())

#total unsolved homicides
homicide_unsolve = homicide_data %>% 
  filter(hom_unsolved == TRUE) %>% 
  group_by(city_state) %>% 
  summarise(hom_unsolved = n())

#total number of homicides and unsolved homicides
homicide_data = left_join(homicide_total, homicide_unsolve)

prop_test = homicide_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  mutate(prop = map2(.x = hom_total, .y = hom_unsolved, ~prop.test(n = .x, x = .y))) %>% 
  broom::tidy() %>% 
  unnest()

pull(prop_test)

prop_test_baltimore = homicide_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  with(., prop.test(n = hom_total, x = hom_unsolved)) %>% broom::tidy()
```

